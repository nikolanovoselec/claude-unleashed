#!/bin/bash

# Claude Unleashed Mode Wrapper Script
# Usage: cu /YON | /YOFF | /STATUS | /HELP | [claude commands]

# Output colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
GREEN='\033[0;32m'
RESET='\033[0m'
BOLD='\033[1m'

# State persistence file
STATE_FILE="$HOME/.claude_yolo_state"

# Read the current mode
get_mode() {
    if [ -f "$STATE_FILE" ]; then
        cat "$STATE_FILE"
    else
        echo "YOLO"  # Default to Unleashed mode
    fi
}

# Set the mode
set_mode() {
    echo "$1" > "$STATE_FILE"
}

# Handle arguments
case "$1" in
    /YON)
        echo -e "${YELLOW}${BOLD}Activating Unleashed mode${RESET}"
        echo -e "${RED}Warning: All safety checks will be disabled${RESET}"
        echo -e "${RED}Claude can access any file without asking${RESET}"
        set_mode "YOLO"
        echo -e "${YELLOW}Unleashed mode is now ON${RESET}"
        ;;

    /YOFF)
        echo -e "${CYAN}${BOLD}Activating Safe mode${RESET}"
        echo -e "${GREEN}Safety checks will be enabled${RESET}"
        echo -e "${GREEN}Claude will ask for permissions${RESET}"
        set_mode "SAFE"
        echo -e "${CYAN}Safe mode is now ON${RESET}"
        ;;

    /STATUS)
        MODE=$(get_mode)
        echo -e "${BOLD}Claude Unleashed Status:${RESET}"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        if [ "$MODE" = "YOLO" ]; then
            echo -e "Mode: ${YELLOW}${BOLD}Unleashed${RESET}"
            echo -e "Safety: ${RED}DISABLED${RESET}"
            echo -e "Permissions: ${RED}BYPASSED${RESET}"
        else
            echo -e "Mode: ${CYAN}${BOLD}Safe${RESET}"
            echo -e "Safety: ${GREEN}ENABLED${RESET}"
            echo -e "Permissions: ${GREEN}REQUIRED${RESET}"
        fi
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        ;;

    /HELP|/H|/?)
        echo -e "${BOLD}Claude Unleashed (cu) - Help${RESET}"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo -e "${CYAN}cu /YON${RESET}     - Enable Unleashed mode (bypass safety)"
        echo -e "${CYAN}cu /YOFF${RESET}    - Enable Safe mode"
        echo -e "${CYAN}cu /STATUS${RESET}  - Show current mode"
        echo -e "${CYAN}cu /HELP${RESET}    - Show this help"
        echo -e "${CYAN}cu [args]${RESET}   - Run Claude in current mode"
        echo -e "━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
        echo -e ""
        echo -e "${BOLD}Examples:${RESET}"
        echo -e "  cu /YON                    # Enable Unleashed mode"
        echo -e "  cu /YOFF                   # Enable Safe mode"
        echo -e "  cu \"write a function\"      # Run Claude in current mode"
        echo -e ""
        echo -e "${BOLD}Mode Persistence:${RESET}"
        echo -e "Your mode choice is saved in ~/.claude_yolo_state"
        echo -e "and persists between terminal sessions."
        ;;

    *)
        # Run Claude in current mode
        MODE=$(get_mode)

        # Check if silent mode is active
        SILENT=0
        # Check env var first
        [ "$CLAUDE_UNLEASHED_SILENT" = "1" ] || [ "$CLAUDE_UNLEASHED_SILENT" = "true" ] && SILENT=1
        # Also check legacy env var
        [ "$CLAUDE_YOLO_SILENT" = "1" ] || [ "$CLAUDE_YOLO_SILENT" = "true" ] && SILENT=1
        # Check CLI flag
        for arg in "$@"; do
            [ "$arg" = "--silent" ] && SILENT=1 && break
        done

        # Show mode before launch
        if [ "$MODE" = "YOLO" ]; then
            [ "$SILENT" -eq 0 ] && echo -e "${YELLOW}[Unleashed]${RESET} Running Claude in Unleashed mode..."
            # Get the directory of this script, resolving symlinks (needed for npm global installs)
            SOURCE="${BASH_SOURCE[0]}"
            while [ -L "$SOURCE" ]; do
                DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
                SOURCE="$(readlink "$SOURCE")"
                # If readlink returned a relative path, resolve it relative to the symlink's dir
                [[ "$SOURCE" != /* ]] && SOURCE="$DIR/$SOURCE"
            done
            SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
            # Run the local claude-unleashed.js
            node "$SCRIPT_DIR/claude-unleashed.js" "$@"
        else
            [ "$SILENT" -eq 0 ] && echo -e "${CYAN}[Safe]${RESET} Running Claude in Safe mode..."
            # Check if claude is installed
            if command -v claude &> /dev/null; then
                claude "$@"
            else
                # If regular claude is not installed, use claude-unleashed with --safe flag
                if command -v claude-unleashed &> /dev/null; then
                    claude-unleashed --safe "$@"
                else
                    echo -e "${RED}Error: Neither claude nor claude-unleashed is installed${RESET}"
                    echo -e "Install with: ${CYAN}npm install -g github:nikolanovoselec/claude-unleashed${RESET}"
                    exit 1
                fi
            fi
        fi
        ;;
esac
